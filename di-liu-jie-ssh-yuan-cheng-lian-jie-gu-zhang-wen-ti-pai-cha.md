第4章 ssh远程连接排查过程

4.1 为什么要远程连接linux系统

在实际的工作场景中，虚拟机界面或物理服务器本地的窗口都是很少能够接触到的，因为服务器装完系统后，都要拉到IDC机房托管，如果是购买了云主机，更碰不到服务器本地显示器了，此时只能通过远程连接的方式管理Linux系统。因此，在装好Linux系统后，学习Linux运维的第一步应该是配置好客户端软件远程（通过ssh软件进行连接）连接Linux系统进行管理。

4.2 ip地址

互联网上的计算机都会有一个唯一的32位的地址，ip地址===&gt;基因一样

我们访问\(找人\)服务器，就必须通过这个IP地址

局域网里也有预留的ip地址192/10/172开头。局域网的ip地址也是唯一。

NAT模式，电脑宿主机的ip在局域网是唯一的，选择了NAT模式创建虚拟机，虚拟机就是一个新的局域网\(私有网络\)

NAT模式：

PC电脑（笔记本）\(总裁\)

NAT\(副总裁\)

虚拟机（员工）（在一个局域网中）

桥接：

PC电脑\(总裁\)

虚拟机\(员工\)

host-only：

PC电脑\(员工\)

虚拟机（员工）

到后期虚拟机IP地址可以设置为相同

4.3 网络连接的整体结构

服务端：提供服务===&gt;sshd服务===&gt;22&lt;===监听 是否有人需要服务

客户端：ssh协议，ip地址，端口号\(需要什么服务\)，用户名和密码

远程连接五要素

协议 IP 端口号 用户名 密码

Ssh\(加密\) 10.0.0.7 22 Root 123456

telnet\(未加密\) 10.0.0.7 23 Root 123456

4.4 服务和进程问题

如果在本地都无法telnet到ssh 的远程端口，可以终端登陆服务器后可以先查看一下，服务器上ssh服务是否正常启动，使用netstat -natlp 可以查看一下相关的进程，如果有该sshd进程，并正常监听，说明可能是其他问题引起，如果没有使用service sshd start 的命令启动一下该服务在进行一下测试。如果启动失败，可以根据相关的提示的报错在逐一进行排查，或提及工单反馈到阿里云的售后协助您排查。

4.5 NetworkManeger是否运行

查看一下服务器上是否有运行NetworkManeger 的服务，这个服务会影响到您的网络，可以使用service NetworkManager status ,查看一下服务状态，如果是开启的，请使用stop命令停止，停止后还需要重启网卡服务，service network restart ；如果没有开启继续排查其他问题；

4.6 检查防火墙的状态

查看一下防火墙是否有拦截，可以先关闭防火墙测试，service iptables stop

4.7 端口号是否更改

当查看sshd 服务正常启动。防火墙关闭或没有拦截，网络服务正常运行时，外部如果还telnet 不到您的默认的端口，此时需要查看一下服务器的默认端口是否有更改，打开ssh的配置文件，vi/etc/ssh/sshd\_config 查看\# port 后面监听的端口是否有更改，默认是22 。以及 listenaddress 后面默认是0.0.0.0 表示全部网卡都监听，如果这里是127.0.0.1 那么代表只能本机上 ssh 连接的。

4.8 是否禁止root用户访问

如果此时端口已经都正常，但无法连接到服务器上，请查看ssh配置文件中是否禁止了 root用户登录，vi/etc/ssh/sshd\_config 中有相关的 参数 PermitRootLogin 看后面是否更改为了no .默认是yes ,即允许root登陆连接

4.9 小结：

4.9.1 第一步：看看路是不是通的：

ping 服务器：排查客户端到服务器端线路问题，ping是常用的网络连通性检查工具（路通否）

tracert -d 服务器IP：跟踪路由器

路由跟踪命令，也可以检查路由是否通畅，-d 是不对域名进行解析

4.9.2 第二步：去服务器端查看

service iptables status 和／etc/init.d／iptalbes status这两个命令都可以查看，等效。

linux防火墙iptables，可能好心办坏事，阻挡了远程连接，关掉防火墙，让道路畅通无阻

4.9.3 第三步：SSH服务问题

telnet + IP地址：查看SSH 22 端口是否打开了（客户端执行）

nmap + IP地址 + -p 22 ：扫描服务器是否开启了22端口

